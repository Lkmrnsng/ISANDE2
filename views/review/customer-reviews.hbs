<div class="reviews-container">
    <div class="reviews-header">
        <h1>My Reviews</h1>
        <p class="subtitle">View and manage your feedback for past orders</p>
    </div>

    {{#if success}}
    <div class="alert alert-success" role="alert">
        {{success}}
    </div>
    {{/if}}

    {{#if error}}
    <div class="alert alert-error" role="alert">
        {{error}}
    </div>
    {{/if}}

    {{#if (eq (length reviews) 0)}}
        <div class="no-reviews">
            <p>You haven't submitted any reviews yet.</p>
            <a href="/customer/orders" class="button-link">View My Orders</a>
        </div>
    {{else}}
        <div class="reviews-list">
            {{#each reviews}}
            <article class="review-card" data-review-id="{{this.reviewID}}">
                <div class="review-header">
                    <div class="review-meta">
                            Review #{{this.reviewID}} for Order #{{this.orderID}}
                        <time datetime="{{this.date}}" class="review-date">
                            {{formatDate this.date}}
                        </time>
                    </div>
                    <div class="review-actions-top">
                        {{#unless this.response}}
                        <div class="action-buttons">
                            <a href="/review/edit/{{this.reviewID}}" 
                               class="edit-btn" 
                               title="Edit review"
                               aria-label="Edit review">
                                <i class="fas fa-edit"></i>
                                <span class="visually-hidden">Edit</span>
                            </a>
                            <button type="button"
                                    class="delete-btn"
                                    onclick="confirmDelete({{this.reviewID}})"
                                    title="Delete review"
                                    aria-label="Delete review">
                                <i class="fas fa-trash"></i>
                                <span class="visually-hidden">Delete</span>
                            </button>
                        </div>
                        {{/unless}}
                    </div>
                </div>

                <div class="review-content">
                    <div class="overall-rating" aria-label="Overall rating: {{this.ratings.overall}} out of 5 stars">
                        <div class="stars" role="img" aria-hidden="true">
                            {{#times this.ratings.overall}}★{{/times}}
                        </div>
                        <span class="rating-value">{{this.ratings.overall}}/5</span>
                    </div>

                    {{#if this.comment}}
                        <p class="review-comment">{{this.comment}}</p>
                    {{/if}}

                    {{#if this.ratings}}
                        <div class="detailed-ratings">
                            {{#each this.ratings}}
                                {{#if (ne @key "overall")}}
                                    {{#if this}}
                                    <div class="rating-item">
                                        <span class="rating-label">{{@key}}</span>
                                        <div class="rating-stars" 
                                             role="img" 
                                             aria-label="{{@key}} rating: {{this}} out of 5 stars"
                                             aria-hidden="true">
                                            {{#times this}}★{{/times}}
                                        </div>
                                    </div>
                                    {{/if}}
                                {{/if}}
                            {{/each}}
                        </div>
                    {{/if}}

                    {{#if this.order}}
                    <div class="order-details">
                        <h4>Order Details</h4>
                        <p>Delivery Date: {{formatDate this.order.deliveryDate}}</p>
                        <p>Status: {{this.order.status}}</p>
                    </div>
                    {{/if}}

                    {{#if this.response}}
                        <div class="sales-response">
                            <h4>Response from Sales Team</h4>
                            <p class="response-text">{{this.response.text}}</p>
                            <time datetime="{{this.response.responseDate}}" class="response-date">
                                Responded on {{formatDate this.response.responseDate}}
                            </time>
                        </div>
                    {{/if}}
                </div>

                <div class="review-tags" aria-label="Review categories">
                    {{#each this.tags}}
                        <span class="tag">{{this}}</span>
                    {{/each}}
                </div>
            </article>
            {{/each}}
        </div>
    {{/if}}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" 
     class="modal" 
     role="dialog" 
     aria-labelledby="deleteModalTitle" 
     aria-modal="true" 
     tabindex="-1"
     style="display: none;">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Delete Review?</h3>
        <p>Are you sure you want to delete this review? This action cannot be undone.</p>
        <div class="modal-actions">
            <button class="modal-btn modal-cancel" onclick="closeModal()">
                Cancel
            </button>
            <button class="modal-btn modal-confirm" onclick="deleteReview()">
                Delete
            </button>
        </div>
    </div>
</div>

<script>
let reviewToDelete = null;

function confirmDelete(reviewId) {
    reviewToDelete = reviewId;
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'flex';
    
    // Focus the modal
    modal.focus();
    
    // Trap focus within modal
    const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    
    function trapFocus(e) {
        if (e.key === 'Tab') {
            if (e.shiftKey && document.activeElement === firstFocusable) {
                e.preventDefault();
                lastFocusable.focus();
            } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                e.preventDefault();
                firstFocusable.focus();
            }
        }
        if (e.key === 'Escape') {
            closeModal();
        }
    }
    
    modal.addEventListener('keydown', trapFocus);
}

function closeModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
    reviewToDelete = null;
    
    // Remove event listener
    modal.removeEventListener('keydown', trapFocus);
}

async function deleteReview() {
    if (!reviewToDelete) return;
    
    try {
        const response = await fetch(`/review/delete/${reviewToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to delete review');
        }

        // Remove the review card with animation
        const reviewCard = document.querySelector(`[data-review-id="${reviewToDelete}"]`);
        reviewCard.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            reviewCard.remove();
            
            // Check if there are no more reviews
            const remainingReviews = document.querySelectorAll('.review-card');
            if (remainingReviews.length === 0) {
                window.location.reload(); // Reload to show no-reviews message
            }
        }, 300);

        closeModal();
    } catch (error) {
        console.error('Error deleting review:', error);
        showError(error.message);
        closeModal();
    }
}

function showError(message) {
    const container = document.querySelector('.reviews-container');
    const alert = document.createElement('div');
    alert.className = 'alert alert-error';
    alert.role = 'alert';
    alert.textContent = message;
    
    container.insertBefore(alert, container.firstChild);
    setTimeout(() => alert.remove(), 5000);
}

</script>

<style>
@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}
</style>